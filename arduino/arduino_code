#include <Wire.h>
#include <Adafruit_MLX90614.h>

Adafruit_MLX90614 mlx = Adafruit_MLX90614();

const int sensorPin[] = {A0};
float distance[1];
const int AVERAGE_OF =50;
const float MCU_VOLTAGE = 5.0;
float initial = 0;
float convertData(float);
float delta;

void setup(){
  Serial.begin(9600); 
 mlx.begin(); 
 
}

void loop(){
  float temperatureValue;
  float delta ;
  temperatureValue = mlx.readObjectTempC();
  
  if(initial == 0){
    initial = readDistance(0);
    delta = initial;
  }
  else {
    delta = initial - readDistance(0);
    initial -= delta;
    }
   readDistance(0);//read sensor 1

  Serial.print("\nDistance =");//print out the value you read
  Serial.print(distance[0]);
  Serial.println("cm");

  Serial.print("Ambient = "); Serial.print(mlx.readAmbientTempC());                         //Celsius
  Serial.print("*C\tObject = "); Serial.print(mlx.readObjectTempC()); Serial.println("*C"); //Celsius
  Serial.print("Ambient = "); Serial.print(mlx.readAmbientTempF());                         //Fahrenheit
  Serial.print("*F\tObject = "); Serial.print(mlx.readObjectTempF()); Serial.println("*F"); //Fahrenheit

  String data = String(convertData(delta)) +" SG " + "," + String(temperatureValue) + "*C";
  Serial.print("Data ");Serial.print(data);
  Serial.println();
  
  delay(5000);
}
float readDistance(int sensor){ //readDistance
      float voltage_temp_average=0;   
      for(int i=0; i < AVERAGE_OF; i++)
    {
      int sensorValue = analogRead(sensorPin[sensor] );
      delay(1);      
      voltage_temp_average +=sensorValue * (MCU_VOLTAGE / 1023.0);
    }
     voltage_temp_average /= AVERAGE_OF;

  // eqution of the fitting curve
  ////33.9 + -69.5x + 62.3x^2 + -25.4x^3 + 3.83x^4
  distance[sensor] = 33.9 + -69.5*(voltage_temp_average) + 62.3*pow(voltage_temp_average,2) + -25.4*pow(voltage_temp_average,3) + 3.83*pow(voltage_temp_average,4);
  return distance[sensor];
}

float convertData(float delta){ // convert delta to SG
   float sg_value;
   sg_value = 0.01*delta + 1;
    
   return sg_value;
    }
